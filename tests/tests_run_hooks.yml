---
- name: Issue simple self-signed certificate
  hosts: all

  vars:
    certificate_requests:
      - name: mycert
        dns: www.example.com
        ca: self-sign
        run_before: >
          touch /tmp/before_cert.tmp
        run_after: >
          touch /tmp/after_cert.tmp
  roles:
    - linux-system-roles.certificate

- name: Verify certificate
  hosts: all
  vars:
    certificates:
      - path: /etc/pki/tls/certs/mycert.crt
        key_path: /etc/pki/tls/private/mycert.key
        subject:
          - CN=www.example.com
        subject_alt_name:
          - DNS:www.example.com
  tasks:
    - name: Verify each certificate
      include_tasks: tasks/assert_certificate_parameters.yml
      loop: "{{ certificates }}"
      loop_control:
        loop_var: cert

    - name: Verify test files timestamp
      block:
        - name: Get certificate timestamp
          stat:
            path: "{{ certificates[0].path }}"
          register: cert_result
        - name: Get pre-run file timestamp
          stat:
            path: /tmp/before_cert.tmp
          register: before_result
        - name: Get post-run file timestamp
          stat:
            path: /tmp/after_cert.tmp
          register: after_result
        - name: Assert file created before cert
          assert:
            that:
              - before_result.stat.mtime < cert_result.stat.mtime
            fail_msg: >-
              {{ before_result.stat.mtime }} >=
              {{ cert_result.stat.mtime }}
        - name: Assert file created after cert
          assert:
            that:
              - after_result.stat.mtime > cert_result.stat.mtime
            fail_msg: >-
              {{ after_result.stat.mtime }} <=
              {{ cert_result.stat.mtime }}
