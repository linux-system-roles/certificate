---
- name: Install IPA server
  hosts: all
  become: true
  tasks:
    - name: run ipa Install
      block:
        - import_tasks: tasks/setup_ipa.yml
      rescue:
        - name: FAILURE - check entropy
          command: cat /proc/sys/kernel/random/entropy_avail
        - name: FAILURE - get logs for debugging
          archive:
            dest: /tmp/ipalogs.tgz
            path:
              - /var/log/messages
              - /var/log/ipaserver-install.log
              - /var/log/ipaclient-install.log
              - /var/log/pki
        - name: FAILURE - grab archive
          fetch:
            src: /tmp/ipalogs.tgz
            dest: /tmp/ipalogs.tgz
        - name: FAILURE - ipa setup failed
          fail:
            msg: FAILURE - ipa setup failed

- name: Issue IPA signed certificate
  hosts: all
  become: true

  vars:
    certificate_requests:
      - name: mycert
        dns: ipaserver.test.local
        principal: HTTP/ipaserver.test.local@TEST.LOCAL
        ca: ipa
  roles:
    - linux-system-roles.certificate

- name: Verify certificate
  hosts: all
  become: true
  vars:
    certificates:
      - path: /etc/pki/tls/certs/mycert.crt
        key_path: /etc/pki/tls/private/mycert.key
        subject:
          - name: commonName
            oid: 2.5.4.3
            value: ipaserver.test.local
          - name: organizationName
            oid: 2.5.4.10
            value: TEST.LOCAL
        subject_alt_name:
          - name: DNS
            value: ipaserver.test.local
          - name: Universal Principal Name (UPN)
            oid: 1.3.6.1.4.1.311.20.2.3
            value: HTTP/ipaserver.test.local@TEST.LOCAL
          - name: Kerberos principalname
            oid: 1.3.6.1.5.2.2
            value: HTTP/ipaserver.test.local@TEST.LOCAL
        # IPA CA doesn't respect the requested key_usage (and that's ok)
        key_usage:
          - digital_signature
          - content_commitment
          - key_encipherment
          - data_encipherment
  tasks:
    - name: Verify each certificate
      include_tasks: tasks/assert_certificate_parameters.yml
      loop: "{{ certificates }}"
      loop_control:
        loop_var: cert
